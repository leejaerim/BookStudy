# [4.4] 서브쿼리 조인

- 실무에서는 복잡한 서브쿼리 조인을 보게 될 것이다.
- 우리의 목표는 어떻게 옵티마이저가 서브쿼리 조인을 처리하는지 이해하고, 원하는 방식으로 실행계획을 제어하는지 공부한다.
- 그 중 첫번째는 옵티마이저가 다양한 방법으로 쿼리변환을 시도하므로 서브쿼리 조인을 이해가 필요하다.

---

### 4.4.1 서브쿼리 변환이 필요한 이유.

- SQL을 최적화에 가장 유리한 형태로 변환하는 작업 → 쿼리 변환이 필요.
- 서브쿼리란 ? 
- 하나의 SQL문 안에 괄호로 묶은 별도의 쿼리 블록.
    1. 스칼라 서브쿼리 - SELECT문단에 선언된 쿼리. 하나의 레코드당 정확히 하나의 값만 반환하는 쿼리.
    2. 인라인 뷰 - from문단에 선언된 뷰 타입 쿼리
    3. 중첩된 서브쿼리 - where절에 선언된 쿼리
- 서브쿼리 별로 최적화된 쿼리가 전체적으로 최적화됐다고 할 수 없다.

---

### 4.4.2 서브쿼리와 조인

- 필터 오퍼레이션 - no-unnest 힌트 (서브쿼리를 풀어내지 말고 그대로 수행하라는 옵티마이저 힌트)
    - 전체적으로는 NL조인과 처리 루틴이 비슷하다.
    - 첫번째 차이 - 메인쿼리의 한 로우가 서브쿼리의 한 로우와 조인에 성공하는 순간 진행을 멈추고 메인쿼리의 다음 로우로 진행한다. → 집합수준으로 확장 방지
    - 두번째 차이 - 캐싱기능의 존재. 입력값에 따른 반환값을 캐싱하는 기능(쿼리단위)
    - 세번째 차이 - 메인쿼리에 서브쿼리가 종속되므로 조인순서가 고정된다. (메인 쿼리가 드라이빙 집합)
- 서브쿼리 Unnesting - 기본적으로 옵티마이저가 선택하지만 명시적으로 unnest 힌트 사영 가능
    - 필터방식은 항상 메인쿼리가 드라이빙 집합이지만, unnesting된 서브쿼리는 메인쿼리보다 선처리 될 수 있다. (Leading 힌트)
        
        ```sql
        select /*+ leading(거래@subq) use_nl(c) */ c.고객번호, c.고객명
        from 고객 c
        where ...
        and exists(
        	select /*+ qb_name(subq) unnest */ 'x'
        	from 거래
        	where 고객번호 = c.고객번호
        		and 거래일시 >= trunc(sysdabe,'mm')
        )
        ---------------------------------------------------------
        select /*+ no_merge(t) leading(t) use_nl(c) */
        from (select distinct 고객번호 from 거래 where 거래일시 >= trunc(sysdate,'mm')) t, 고객 c
        where ...
        ---------------------------------------------------------
        select c.고객번호, c.고객명
        from 고객 c
        where ...
        and exists(
        	select /*+ unnest hash_sj */ 'x'
        	from 거래
        	where 고객번호 = c.고객번호
        		and 거래일시 >= trunc(sysdabe,'mm')
        )
        ```
        
    - 서브쿼리를 Unnesting 해서  메인쿼리와 같은 레벨로 만들면 다양한 조인 메서드/순서를 선택할 수 있다.(더많은 옵션)
- 서브쿼리 Pushing
    - 서브쿼리 필터링을 가능한 한 앞 단계에서 처리하도록 강제하는 기능으로 , push_subq/no_push_subq 힌트로 제어한다.
    - Unnesting되지 않은 서브쿼리는 항상 필터 방식으로 맨마지막 단계에서 처리되는데, 이를 먼저 처리하게 하려고 push_subq 힌트를 줄수 있다.
    - 중요한 것은, Unnesting되지 않은 서브쿼리에만 작동한다.
    - push_subq 힌트는 항상 no_unnest 힌트와 같이 사용한다.

### 4.4.3 뷰와 조인

- 최적화 단위인 쿼리블록으로 옵티마이저는 뷰 쿼리 블록을 독립적으로 최적화한다.

### 4.4.4 스칼라 서브쿼리 조인

- 스칼라 서브쿼리 캐싱 효과
    - 부작용도 존재할 수 있다.
- 스칼라 서브쿼리 Unnesting