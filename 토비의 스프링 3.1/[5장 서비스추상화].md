# [5장 서비스추상화]

### ***목표 : 성격이 비슷한 여러 종류의 기술을 추상화하고 일관되게 관리할 수 있는지 살펴본다.***

---

### LEVEL ENUM

- 간단한 숫자 타입으로 상수를 정의하는 것은 위험하며, 관리되지 못한다.
- ENUM을 통한 안전하고 간편한 상태관리

```java
public enum Level{
	BASIC(1), SILVER(2), GOLD(3);
	private final int value;
	Level(int value){
		this.value = value;
	}
	public int intValue(){
		return value;
	}
	public static Level valueOf(int value){
		switch(value){
			case 1 : return BASIC;
			case 2 : return BASIC;
			case 3 : return BASIC;
			default : throw new AssertionError("Unknown value : " + value);
		}
	}
}
```

- ENUM은 오브젝트로  DB에 저장될 수 있는 SQL타입이 아니다. → 저장가능한 정수형으로 변환
    - `intValue()`

---

### 5.1.3 UserService.upgradeLevels()

- DAO는 데이터를 가져오고 조작할 뿐, 비지니스 로직을 제공하지 않는다.

```java
public class UserService{
	UserDao userDao;
	public void setUserDao(UserDao UserDao){
		this.userDao = userDao;
	}
}
```

- `userDao`를 주입받아 사용하게 된다.

```xml
<bean id="userService" class ="...">
	<property name ="userDao" ref="userDao"/>
</bean>
<bean id="userDao" class="...">
	<property name="dataSource" ref="dataSource"/>
</bean> 
```

### UpgradeLevels() 리팩토링

```java
public void upgradeLevels(){
	List<User> users = userDao.getAll();
	for(User user : users){
		if(canUpgradeLevel(user)){
			upgradeLevel(user);			
		}
	}
}
private boolean canUpgradeLevel(User user){
	Level currentLevel = user.getLevel();
	switch(currentLevel){
		case BASIC : return (user.getLogin() >= 50);
		case SILVER : return (user.getRecommend() >= 30);
		case GOLD : return false;
		default : throw...
	}
}
private void upgradeLevel(User user){
	if(user.getLevel() == Level.BASIC) user.setLevel(Level.SILVER);
	else if(user.getLevel() == Level.SILVER) user.setLevel(Level.GOLD);
	userDao.update(user)
}
```

- UserService가 아닌 User 오브젝트에서 상태를 변경하도록 지시 (객체지향)

```java
public void upgradeLevel(){
	Level nextLevel = this.level.nextLevel();
	if(nextLevel == null){
		throw
	}
	else{
		this.level = nextLevel;
	}
}
//----------------------
//기존의 upgradeLevel 은 다음과 같이 변경
private void upgradeLevel(User user){
	user.upgradeLevel();
	userDao.update(user);
}
```

- 레벨 정책을 좀더 유연하게 변경 하기 위해서 개선이 필요할 수 있다.
    - 특정 정책을 삽입하기 위해 기존 정책을 지우는 것은 매우 위험하기때문이다.
    - 이럴땐 업그레이드 정책 인터페이스를 통해 DI해준다.
    
    ```java
    public interface UserLavelUpgradePolicy{
    	boolean canUpgradeLevel(User user);
    	void upgradeLevel(User user);
    }
    ```