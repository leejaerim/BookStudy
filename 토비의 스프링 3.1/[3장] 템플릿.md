# [3ì¥] í…œí”Œë¦¿

<aside>
ğŸ“Œ í…œí”Œë¦¿ : ë³€ê²½ì´ ì¼ì–´ë‚˜ì§€ ì•ŠëŠ” ë¶€ë¶„ê³¼ ì¼ì–´ë‚˜ëŠ” ë¶€ë¶„ì„ ë…ë¦½ì ìœ¼ë¡œ ë¶„ë¦¬ì‹œì¼œ íš¨ê³¼ì ìœ¼ë¡œ ì‚¬ìš©í•˜ê³ ì í•¨.

</aside>

### ì˜ˆì™¸ì²˜ë¦¬ ê¸°ëŠ¥ì„ ê°–ì¶˜ DAO

- ì˜ˆì™¸ ì²˜ë¦¬ ì—†ì´ ì—ëŸ¬ê°€ ë‚˜ê²Œë˜ë©´, ë¦¬ì†ŒìŠ¤ì˜ ë°˜ë‚©*close() ì—†ì´ êµ¬ë¬¸ì´ ì¢…ë£Œëœë‹¤.
â†’ ì´ëŠ” ì¥ê¸°ì ìœ¼ë¡œ ë³´ë©´ ì‹¬ê°í•œ ë¦¬ì†ŒìŠ¤ ì—ëŸ¬
- try&catch&finally ë¥¼ ì‚¬ìš©í•´ë³¸ë‹¤.

```java
try{
	c= dataSource.getConnection();
	ps = c.prepareStatement("Delete from users");
	rs = ps.executeQuery();//SELECT ì¡°íšŒì‹œ.
	rs.next();
	ps.executeUpdate();
}catch(SQLException e){ throw e;}
finally{
	if(ps != null){
		try{ps.close();}catch(SQLException e){...}
	}
	if(c != null){
		try{c.close();}catch(SQLException e){...}
	}
	if(rs != null){
		try{rs.close();}catch(SQLException e){...}
	}
}
```

- ì–´ëŠ ì‹œì ì— ì—ëŸ¬ê°€ ë‚¬ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ì—†ìœ¼ë‹ˆ, psì™€ cÂ ëª¨ë‘ì— ëŒ€í•œ closeë¥¼ í˜¸ì¶œí•´ì£¼ì–´ì•¼ í•œë‹¤.
- ~~ë„ˆë¬´ ì§€ì €ë¶„í•˜ë‹¤â€¦.~~

---

- ìœ„ì—ì„œ ì§  ì½”ë“œì˜ ë¬¸ì œì ì€ ì¤‘ë³µë„ ì‹¬í•˜ê³  ì–¸ì œ ì–´ë””ì„œ ë¬¸ì œê°€ ë ì§€ íŒŒì•…ë„ í˜ë“¤ë‹¤ëŠ” ì ì´ë‹¤.
- ***ë°”ë¡œ ì—¬ê¸°ì„œ ë³€í•˜ëŠ” ì ê³¼ ë³€í•˜ì§€ ì•ŠëŠ” ì ì„ ë¶„ë¦¬í•˜ëŠ” í…œí”Œë¦¿ ì‘ì—…ì„ í•˜ê²Œ ëœë‹¤.***
- ë©”ì†Œë“œì˜ ì¶”ì¶œ : ë³€í•˜ëŠ” ë¶€ë¶„ì„ ë©”ì„œë“œë¡œ ì¶”ì¶œ.

```java
public void deleteAll() throws SQLException{
	try{
		c = dataSource.getConnection();
		ps = makeStatement(c);
		ps.executeUpdate();
	}catch(SQLException e){...}
}
private PreparedStatement makeStatement(Connection c) throws SQLException{
	PreparedStatement ps;
	ps = c.prepareStatement("Delete from users");
	return ps;
}
```

***â†’ í…œí”Œë¦¿ ë©”ì„œë“œ íŒ¨í„´ì˜ ì ìš©***

- ë³€í•˜ì§€ ì•ŠëŠ” ë¶€ë¶„ì€ ìŠˆí¼í´ë˜ìŠ¤ì— ë‘ê³  ë³€í•˜ëŠ” ë¶€ë¶„ì€ ì¶”ìƒë©”ì„œë“œë¡œ ì •ì˜í•´ë‘¬ì„œ ì„œë¸Œí´ë˜ìŠ¤ì—ì„œ ì˜¤ë²„ë¼ì´ë“œí•´ì„œ ìƒˆë¡­ê²Œ ì •ì˜í•˜ì—¬ ì‚¬ìš©.

```java
public class UserDaoDeleteAll extends UserDao{
	protected PreparedStatement makeStatement(Connection c) throws SQLException{...}
}
```

- UserDaoí´ë˜ìŠ¤ì˜ ê¸°ëŠ¥ì„ í™•ì¥í•˜ê³  ì‹¶ì„ë•Œë§ˆë‹¤ ìƒì†ì„ í†µí•´ ììœ ë¡­ê²Œ í™•ì¥í•  ìˆ˜ ìˆê³ , OCPì›ì¹™ë„ ì¤€ìˆ˜í•œë‹¤.
- ë‹¨ì 
    - DAOë¡œì§ë§ˆë‹¤ ìƒì†ì„ í†µí•´ ìƒˆë¡œìš´ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ì•¼í•œë‹¤.

---

***â†’ ì „ëµ íŒ¨í„´ì˜ ì‚¬ìš©***

- OCPë¥¼ ì§€í‚¤ë©´ì„œë„ í™•ì¥ì„±ê³¼ ìœ ì—°ì„±ì„ ê°–ëŠ” íŒ¨í„´
- ë³€í•˜ì§€ ì•ŠëŠ” ë¶€ë¶„ì„ contextMethod()ë¡œ ë‘ê³ , íŠ¹ì • í™•ì¥ê¸°ëŠ¥ì„ ì ì ˆí•˜ê²Œ ë³„ë„ì˜ í´ë˜ìŠ¤ì¸ Strategy ê°ì²´ì˜ ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ êµ¬í˜„.

```java
public interface StatementStrategy{
	PreparedStatement makePreparedStatement(Connection c) throws SQLException;
}
---
public class DeleteAllStatement implements StatementStrategy{
	public PreparedStatement makePreparedStatement(Connection c) throws SQLException{
	PreparedSatement ps = c.prepareSatement("delete from users");	
		return ps;
	}
}
---
// Called IN ContextMethod 
public void deleteAll() throws SQLException{
	...
	StatementStrategy strategy = new DeleteAllStatement();
	ps = strategy.makePreparedStatement();
	ps.executeUpdate();
}
```

- ë‹¨ì  :  ì´ë ‡ê²Œ ì»¨í…ìŠ¤íŠ¸ ì•ˆì—ì„œ ì´ë¯¸ êµ¬ì²´ì ì¸ ì „ëµí´ë˜ìŠ¤ê°€ ì„ ì–¸ë˜ì–´ ë²„ë¦¬ë©´ OCPë„ ìœ ì—°ì„±ë„ ìƒì‹¤ë˜ê¸° ë§ˆë ¨ì´ë‹¤.
- ê·¸ë˜ì„œ ì–´ëŠ ì „ëµí´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê²Œ ë ì§€ëŠ” í´ë¼ì´ì–¸íŠ¸ê¹Œì§€ ë°€ì–´ë‚¸ë‹¤. ìµœëŒ€í•œ.
- ***DIë€, ê²°êµ­ ì´ëŸ¬í•œ ì „ëµíŒ¨í„´ì˜ ì¥ì ì„ ì¼ë°˜ì ìœ¼ë¡œ í™œìš©í•  ìˆ˜ ìˆëŠ” êµ¬ì¡°.***
- ì»¨í…ìŠ¤íŠ¸ë¥¼ ë¶„ë¦¬í•œ ë©”ì„œë“œ ì½”ë“œ

```java
public void jdbcContextWithStatementStrategy(StatementStrategy stmt) throws SQLException{
	...
	ps = stmt.makePreparedStatement(c);
	...
}
```

- ë¶„ë¦¬ëœ ì»¨í…ìŠ¤íŠ¸ë¥¼ í´ë¼ì´ì–¸íŠ¸ ì±…ì„ì„ ë‹´ë‹¹í•  deleteAll() ë©”ì„œë“œ

```java
public void deleteAll(){
	//ì „ëµí´ë˜ìŠ¤ì˜ ì˜¤ë¸Œì íŠ¸ ìƒì„±
	StatementStrategy stmt = new DeleteAllStatement();
	//ì „ëµì˜¤ë¸Œì íŠ¸ì˜ ì „ë‹¬ ì»¨í…ìŠ¤íŠ¸ í˜¸ì¶œ
	jdbcContextWithStatementStrategy(st);
}
```

---

### JDBC ì „ëµ íŒ¨í„´ì˜ ìµœì í™”

- ì´ë ‡ê²Œ `jdbcContextWithStatementStrategy` ì™€ `interfaceë¥¼ implementsí•œ StatementStrategy` ì„ ì´ìš©í•´ì„œ JDBC Contextë¥¼ ìµœì í™”í•  ìˆ˜ ìˆì—ˆë‹¤.
- ì¶”ê°€ì ì¸ ê°œì„ ì 
1. DAOë©”ì„œë“œë§ˆë‹¤ ìƒˆë¡œìš´ ì „ëµ êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ì•¼ í•œë‹¤.
2. ì „ëµí´ë˜ìŠ¤ì— ì „ë‹¬í•œ ë¶€ê°€ì •ë³´ê°€ ìˆì„ ê²½ìš°, ì¶”ê°€ì ì¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë§Œë“¤ì–´ì„œ ì£¼ì…í•´ì•¼ ëœë‹¤.
- ì „ëµí´ë˜ìŠ¤ì˜ ***ë‚´ë¶€ ë¡œì»¬í´ë˜ìŠ¤***ë¡œ ë§Œë“¤ì–´ë²„ë¦°ë‹¤. â†’ UserDAO ì—ì„œë§Œ ì‚¬ìš©ê°€ëŠ¥í•œ ë¡œì»¬í´ë˜ìŠ¤
- ìì‹ ì´ ì„ ì–¸ëœ ê³³ì˜ ì •ë³´ë¥¼ ì ‘ê·¼ë„ í• ìˆ˜ìˆë‹¤.

```java
public void add(final User user) throws SQLException{
	class AddStatement implements StatementStrategy{
		...
		ps.setString(1, user.getId())//ë¡œì»¬í´ë˜ìŠ¤ì˜ ì½”ë“œì—ì„œ ì™¸ë¶€ë©”ì„œë“œì˜ ë¡œì»¬ë³€ìˆ˜ì— ì§ì ‘ ì ‘ê·¼ê°€ëŠ¥
		...
	}
	StatementStrategy st = new AddStatement();
	jdbcContextWithStatementStrategy(st);
}
```

- ***ìµëª… ë‚´ë¶€ í´ë˜ìŠ¤***

```java
public void add(final User user) throws SQLException{
	jdbcContextWithStatementStrategy({
		new StatementStrategy(){
			public PreparedStatement makePreparedStatement(Connection c) throws SQLException{
				...
				return ps;
			}
		}
	}
}
```

---

### 3.4 ì»¨í…ìŠ¤íŠ¸ì™€ DI

- jdbccontext ë¥¼ ë¶„ë¦¬ì‹œì¼œ ëª¨ë“  DAOì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•˜ì.

```java
public class jdbcContext{
	private DataSource dataSource;
	public void setDataSource(DataSource dataSource){...}
	public void workWithStatementStrategy(StatementStrategy stmt) throws SQLExcetion{
		Connection c =null;
		PreparedStatement ps = null;
		try{
			c = this.dataSource.getConnection();
			ps = stmt.makePreparedStatement(c);
			ps.executeUpdate();
		}catch(SQLExcpetion e){ throw e;}
		finally{...}
	}
}
public class UserDao{
	private JdbcContext jdbcContext;
	public void setJdbcContext(...){...}
	public void add(final User user){
		this.jdbcContext.workWithStatementStrategy(
			new StatementStrategy(){...}
		)
	}
}
```

- ë¹ˆ ì˜ì¡´ê´€ê³„ ë³€ê²½ - ëŸ°íƒ€ì„ì‹œì— ë§Œë“¤ì–´ì§€ëŠ” ì˜¤ë¸Œì íŠ¸ ë ˆë²¨ì˜ ì˜ì¡´ê´€ê³„ì— ë”°ë¼ ì •ì˜ë˜ê³ , ì˜ì¡´ê´€ê³„ xml ìˆ˜ì •

```xml
<bean id="userDao" class="spring.user.dao.UserDao">
	<property name="dataSource" ref="dataSource"/>
	<property name="jdbcContext" ref="jdbcContext"/>
</bean>
```

---

### ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ DI

<aside>
ğŸ“Œ ëŸ°íƒ€ì„ì‹œì— ì˜ì¡´í•  ì˜¤ë¸Œì íŠ¸ì™€ì˜ ê´€ê³„ë¥¼ ë‹¤ì´ë‚´ë¯¹í•˜ê²Œ ì£¼ì…í•´ì£¼ëŠ” ê²ƒ â†’ ì˜ì¡´ê´€ê³„ DI ê°œë…

</aside>

JdbcContextë¥¼ UserDaoì™€ DI êµ¬ì¡°ë¡œ ë§Œë“¤ì–´ì•¼ í•  ì´ìœ 

1. JdbcContextê°€ ìŠ¤í”„ë§ì»¨í…Œì´ë„ˆì˜ ì‹±ê¸€í†¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì—ì„œ ê´€ë¦¬ë˜ëŠ” ì‹±ê¸€í†¤ ë¹ˆ
â†’ ì¼ì¢…ì˜ ì„œë¹„ìŠ¤ ì˜¤ë¸Œì íŠ¸ë¡œ ì˜ë¯¸ê°€ ìˆìŒ(ì˜¤ë¸Œì íŠ¸ ê³µìœ )
2. JdbcContextê°€ DIë¥¼ í†µí•´ ë‹¤ë¥¸ ë¹ˆì— ì˜ì¡´í•˜ê³  ìˆê¸° ë•Œë¬¸ì´ë‹¤.
â†’ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆê°€ ê´€ë¦¬í•˜ëŠ” iocëŒ€ìƒì´ì—¬ì•¼ DIê°€ ê°€ëŠ¥í•˜ë‹¤.
- ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì€ ì´ìœ ì— ëŒ€í•´ì„œ ìƒê°í•´ë³¸ë‹¤.
- UserDaoì™€ jdbcContextëŠ” ë§¤ìš° ê¸´ë°€í•œ ê´€ê³„ì˜ ë†’ì€ ì‘ì§‘ë„ë¥¼ ê°–ê³  ìˆê¸° ë•Œë¬¸ì— ì¸í„°í˜ì´ìŠ¤ ì—†ì´ ê°•ë ¥í•˜ê²Œ ì—°ê²°ëœ ê´€ê³„ë¥¼ í—ˆìš©í•  ìˆ˜ ìˆë‹¤.

---

### ì½”ë“œë¥¼ ì´ìš©í•œ ìˆ˜ë™ DI

- DAOë§ˆë‹¤ í•˜ë‚˜ì˜ JdbcContextë¥¼ ê°–ê²Œ í•˜ì—¬ ì„¤ê³„.
- ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡ ë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ JdbcContext ì˜¤ë¸Œì íŠ¸ì— ëŒ€í•œ ***ìƒì„±ì£¼ê¸°ë¥¼ ê´€ë¦¬***í•´ì£¼ì–´ì•¼ í•œë‹¤.
- DAOì—ê²Œ ì œì–´ê¶Œì„ ë§¡ê¸°ëŠ” ë°©ë²•ìœ¼ë¡œ ìˆ˜ë™ DI ë¥¼ ë°›ëŠ”ë‹¤.
- JdbcContextì— ì£¼ì…í•´ì¤„ ì˜ì¡´ì˜¤ë¸Œì íŠ¸ DataSourceë¥¼ userDaoê°€ ëŒ€ì‹  DI ë°›ë„ë¡ í•œë‹¤.

```java
public class UserDao{
	private JdbcContext jdbcContext;
	public void setDataSource(DataSource dataSource){
		this.jdbcContext = new JdbcContext();//IOC
		this.jdbcContext.setDataSource(dataSource);//DI
		this.dataSource = dataSource;//ì•„ì§ DI ë˜ì§€ ëª»í•œ DAOë¥¼ ìœ„í•´ ë‚¨ê²¨ë‘”ë‹¤.
	}
}
```

---

- ê´€ê³„ê°€ ì™¸ë¶€ì— ë“œëŸ¬ë‚˜ì§€ ì•ŠëŠ” ì¥ì ì´ ìˆìœ¼ë‚˜, ì‹±ê¸€í†¤ìœ¼ë¡œ ë§Œë“¤ìˆ˜ ì—†ê³ , DIë¥¼ ìœ„í•œ ì¶”ê°€ ì½”ë“œê°€ í•„ìš”í•˜ë‹¤.

---

### 3.5 í…œí”Œë¦¿ê³¼ ì½œë°±

- ***ì´ì „ì— ì‘ì—…í–ˆë˜, ì „ëµíŒ¨í„´ì˜ ì»¨í…ìŠ¤íŠ¸ë¥¼ í…œí”Œë¦¿, ìµëª… ë‚´ë¶€í´ë˜ìŠ¤ë¡œ ë§Œë“¤ì–´ì§€ëŠ” ì˜¤ë¸Œì íŠ¸ë¥¼ ì½œë°±***
- ì½œë°±ì€ ì¼ë°˜ì ìœ¼ë¡œ í•˜ë‚˜ì˜ ë©”ì†Œë“œë¥¼ ê°€ì§„ ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ ìµëª… ë‚´ë¶€í´ë˜ìŠ¤.
    - DI ë°©ì‹ì˜ ì „ëµíŒ¨í„´ êµ¬ì¡°.
    - í´ë¼ì´ì–¸íŠ¸ê°€ í…œí”Œë¦¿ ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ë©´ì„œ ì½œë°± ì˜¤ë¸Œì íŠ¸ë¥¼ ì „ë‹¬í•˜ëŠ”ë° ë©”ì†Œë“œë ˆë²¨ì—ì„œ ì¼ì–´ë‚˜ëŠ” DIë¡œ ë³¼ ìˆ˜ ìˆë‹¤.
    - í…œí”Œë¦¿ì—ì„œ ì‘ì—…í•˜ë‹¤ê°€ ì½œë°±ì„ í†µí•´ ì°¸ì¡°ê²°ê³¼ë¥¼ ë°›ì•„ ê²°ê³¼ë¥¼ ë¦¬í„´í•˜ëŠ” í˜•ì‹

```java
public void deleteAll() throws SQLException{
		executeSql("delete from users");
}
private void executeSql(final String query)throws SQLException{
	this.jdbcContext.workWithStatementStrategy(//í…œí”Œë¦¿
		new StatementStrategy(){//ì½œë°±(ìµëª…ë‚´ë¶€í´ë˜ìŠ¤)
			public PreparedStatement makePreparedStatement(Connect c) throws SQLException{
				return c.prepareStatement(query);
			}
		}
	)
}//ì¬í™œìš© ê°€ëŠ¥í•œ ì½œë°±ì„ ë‹´ì€ ë©”ì†Œë“œ
```

- ***ë³€í•˜ëŠ” ë¶€ë¶„ê³¼ ë³€í•˜ì§€ ì•ŠëŠ” ë¶€ë¶„ì„ ë¶„ë¦¬í•˜ì—¬ ìœ ì—°í•˜ê²Œ ì¬í™œìš© í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ê²ƒì´ ë³¸ì§ˆ.***

---

### 3.5.3 í…œí”Œë¦¿/ì½œë°±ì˜ ì‘ìš©