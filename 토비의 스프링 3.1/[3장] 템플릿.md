# [3ì¥] í…œí”Œë¦¿

<aside>
ğŸ“Œ í…œí”Œë¦¿ : ë³€ê²½ì´ ì¼ì–´ë‚˜ì§€ ì•ŠëŠ” ë¶€ë¶„ê³¼ ì¼ì–´ë‚˜ëŠ” ë¶€ë¶„ì„ ë…ë¦½ì ìœ¼ë¡œ ë¶„ë¦¬ì‹œì¼œ íš¨ê³¼ì ìœ¼ë¡œ ì‚¬ìš©í•˜ê³ ì í•¨.

</aside>

### ì˜ˆì™¸ì²˜ë¦¬ ê¸°ëŠ¥ì„ ê°–ì¶˜ DAO

- ì˜ˆì™¸ ì²˜ë¦¬ ì—†ì´ ì—ëŸ¬ê°€ ë‚˜ê²Œë˜ë©´, ë¦¬ì†ŒìŠ¤ì˜ ë°˜ë‚©*close() ì—†ì´ êµ¬ë¬¸ì´ ì¢…ë£Œëœë‹¤.
â†’ ì´ëŠ” ì¥ê¸°ì ìœ¼ë¡œ ë³´ë©´ ì‹¬ê°í•œ ë¦¬ì†ŒìŠ¤ ì—ëŸ¬
- try&catch&finally ë¥¼ ì‚¬ìš©í•´ë³¸ë‹¤.

```java
try{
	c= dataSource.getConnection();
	ps = c.prepareStatement("Delete from users");
	rs = ps.executeQuery();//SELECT ì¡°íšŒì‹œ.
	rs.next();
	ps.executeUpdate();
}catch(SQLException e){ throw e;}
finally{
	if(ps != null){
		try{ps.close();}catch(SQLException e){...}
	}
	if(c != null){
		try{c.close();}catch(SQLException e){...}
	}
	if(rs != null){
		try{rs.close();}catch(SQLException e){...}
	}
}
```

- ì–´ëŠ ì‹œì ì— ì—ëŸ¬ê°€ ë‚¬ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ì—†ìœ¼ë‹ˆ, psì™€ cÂ ëª¨ë‘ì— ëŒ€í•œ closeë¥¼ í˜¸ì¶œí•´ì£¼ì–´ì•¼ í•œë‹¤.
- ~~ë„ˆë¬´ ì§€ì €ë¶„í•˜ë‹¤â€¦.~~

---

- ìœ„ì—ì„œ ì§  ì½”ë“œì˜ ë¬¸ì œì ì€ ì¤‘ë³µë„ ì‹¬í•˜ê³  ì–¸ì œ ì–´ë””ì„œ ë¬¸ì œê°€ ë ì§€ íŒŒì•…ë„ í˜ë“¤ë‹¤ëŠ” ì ì´ë‹¤.
- ***ë°”ë¡œ ì—¬ê¸°ì„œ ë³€í•˜ëŠ” ì ê³¼ ë³€í•˜ì§€ ì•ŠëŠ” ì ì„ ë¶„ë¦¬í•˜ëŠ” í…œí”Œë¦¿ ì‘ì—…ì„ í•˜ê²Œ ëœë‹¤.***
- ë©”ì†Œë“œì˜ ì¶”ì¶œ : ë³€í•˜ëŠ” ë¶€ë¶„ì„ ë©”ì„œë“œë¡œ ì¶”ì¶œ.

```java
public void deleteAll() throws SQLException{
	try{
		c = dataSource.getConnection();
		ps = makeStatement(c);
		ps.executeUpdate();
	}catch(SQLException e){...}
}
private PreparedStatement makeStatement(Connection c) throws SQLException{
	PreparedStatement ps;
	ps = c.prepareStatement("Delete from users");
	return ps;
}
```

***â†’ í…œí”Œë¦¿ ë©”ì„œë“œ íŒ¨í„´ì˜ ì ìš©***

- ë³€í•˜ì§€ ì•ŠëŠ” ë¶€ë¶„ì€ ìŠˆí¼í´ë˜ìŠ¤ì— ë‘ê³  ë³€í•˜ëŠ” ë¶€ë¶„ì€ ì¶”ìƒë©”ì„œë“œë¡œ ì •ì˜í•´ë‘¬ì„œ ì„œë¸Œí´ë˜ìŠ¤ì—ì„œ ì˜¤ë²„ë¼ì´ë“œí•´ì„œ ìƒˆë¡­ê²Œ ì •ì˜í•˜ì—¬ ì‚¬ìš©.

```java
public class UserDaoDeleteAll extends UserDao{
	protected PreparedStatement makeStatement(Connection c) throws SQLException{...}
}
```

- UserDaoí´ë˜ìŠ¤ì˜ ê¸°ëŠ¥ì„ í™•ì¥í•˜ê³  ì‹¶ì„ë•Œë§ˆë‹¤ ìƒì†ì„ í†µí•´ ììœ ë¡­ê²Œ í™•ì¥í•  ìˆ˜ ìˆê³ , OCPì›ì¹™ë„ ì¤€ìˆ˜í•œë‹¤.
- ë‹¨ì 
    - DAOë¡œì§ë§ˆë‹¤ ìƒì†ì„ í†µí•´ ìƒˆë¡œìš´ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ì•¼í•œë‹¤.

---

***â†’ ì „ëµ íŒ¨í„´ì˜ ì‚¬ìš©***

- OCPë¥¼ ì§€í‚¤ë©´ì„œë„ í™•ì¥ì„±ê³¼ ìœ ì—°ì„±ì„ ê°–ëŠ” íŒ¨í„´
- ë³€í•˜ì§€ ì•ŠëŠ” ë¶€ë¶„ì„ contextMethod()ë¡œ ë‘ê³ , íŠ¹ì • í™•ì¥ê¸°ëŠ¥ì„ ì ì ˆí•˜ê²Œ ë³„ë„ì˜ í´ë˜ìŠ¤ì¸ Strategy ê°ì²´ì˜ ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ êµ¬í˜„.

```java
public interface StatementStrategy{
	PreparedStatement makePreparedStatement(Connection c) throws SQLException;
}
---
public class DeleteAllStatement implements StatementStrategy{
	public PreparedStatement makePreparedStatement(Connection c) throws SQLException{
	PreparedSatement ps = c.prepareSatement("delete from users");	
		return ps;
	}
}
---
// Called IN ContextMethod 
public void deleteAll() throws SQLException{
	...
	StatementStrategy strategy = new DeleteAllStatement();
	ps = strategy.makePreparedStatement();
	ps.executeUpdate();
}
```

- ë‹¨ì  :  ì´ë ‡ê²Œ ì»¨í…ìŠ¤íŠ¸ ì•ˆì—ì„œ ì´ë¯¸ êµ¬ì²´ì ì¸ ì „ëµí´ë˜ìŠ¤ê°€ ì„ ì–¸ë˜ì–´ ë²„ë¦¬ë©´ OCPë„ ìœ ì—°ì„±ë„ ìƒì‹¤ë˜ê¸° ë§ˆë ¨ì´ë‹¤.
- ê·¸ë˜ì„œ ì–´ëŠ ì „ëµí´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê²Œ ë ì§€ëŠ” í´ë¼ì´ì–¸íŠ¸ê¹Œì§€ ë°€ì–´ë‚¸ë‹¤. ìµœëŒ€í•œ.
- ***DIë€, ê²°êµ­ ì´ëŸ¬í•œ ì „ëµíŒ¨í„´ì˜ ì¥ì ì„ ì¼ë°˜ì ìœ¼ë¡œ í™œìš©í•  ìˆ˜ ìˆëŠ” êµ¬ì¡°.***
- ì»¨í…ìŠ¤íŠ¸ë¥¼ ë¶„ë¦¬í•œ ë©”ì„œë“œ ì½”ë“œ

```java
public void jdbcContextWithStatementStrategy(StatementStrategy stmt) throws SQLException{
	...
	ps = stmt.makePreparedStatement(c);
	...
}
```

- ë¶„ë¦¬ëœ ì»¨í…ìŠ¤íŠ¸ë¥¼ í´ë¼ì´ì–¸íŠ¸ ì±…ì„ì„ ë‹´ë‹¹í•  deleteAll() ë©”ì„œë“œ

```java
public void deleteAll(){
	//ì „ëµí´ë˜ìŠ¤ì˜ ì˜¤ë¸Œì íŠ¸ ìƒì„±
	StatementStrategy stmt = new DeleteAllStatement();
	//ì „ëµì˜¤ë¸Œì íŠ¸ì˜ ì „ë‹¬ ì»¨í…ìŠ¤íŠ¸ í˜¸ì¶œ
	jdbcContextWithStatementStrategy(st);
}
```

---

### JDBC ì „ëµ íŒ¨í„´ì˜ ìµœì í™”

- ì´ë ‡ê²Œ `jdbcContextWithStatementStrategy` ì™€ `interfaceë¥¼ implementsí•œ StatementStrategy` ì„ ì´ìš©í•´ì„œ JDBC Contextë¥¼ ìµœì í™”í•  ìˆ˜ ìˆì—ˆë‹¤.
- ì¶”ê°€ì ì¸ ê°œì„ ì 
1. DAOë©”ì„œë“œë§ˆë‹¤ ìƒˆë¡œìš´ ì „ëµ êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ì•¼ í•œë‹¤.
2. ì „ëµí´ë˜ìŠ¤ì— ì „ë‹¬í•œ ë¶€ê°€ì •ë³´ê°€ ìˆì„ ê²½ìš°, ì¶”ê°€ì ì¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë§Œë“¤ì–´ì„œ ì£¼ì…í•´ì•¼ ëœë‹¤.
- ì „ëµí´ë˜ìŠ¤ì˜ ***ë‚´ë¶€ ë¡œì»¬í´ë˜ìŠ¤***ë¡œ ë§Œë“¤ì–´ë²„ë¦°ë‹¤. â†’ UserDAO ì—ì„œë§Œ ì‚¬ìš©ê°€ëŠ¥í•œ ë¡œì»¬í´ë˜ìŠ¤
- ìì‹ ì´ ì„ ì–¸ëœ ê³³ì˜ ì •ë³´ë¥¼ ì ‘ê·¼ë„ í• ìˆ˜ìˆë‹¤.

```java
public void add(final User user) throws SQLException{
	class AddStatement implements StatementStrategy{
		...
		ps.setString(1, user.getId())//ë¡œì»¬í´ë˜ìŠ¤ì˜ ì½”ë“œì—ì„œ ì™¸ë¶€ë©”ì„œë“œì˜ ë¡œì»¬ë³€ìˆ˜ì— ì§ì ‘ ì ‘ê·¼ê°€ëŠ¥
		...
	}
	StatementStrategy st = new AddStatement();
	jdbcContextWithStatementStrategy(st);
}
```

- ***ìµëª… ë‚´ë¶€ í´ë˜ìŠ¤***

```java
public void add(final User user) throws SQLException{
	jdbcContextWithStatementStrategy({
		new StatementStrategy(){
			public PreparedStatement makePreparedStatement(Connection c) throws SQLException{
				...
				return ps;
			}
		}
	}
}
```

---

### 3.4 ì»¨í…ìŠ¤íŠ¸ì™€ DI

- jdbccontext ë¥¼ ë¶„ë¦¬ì‹œì¼œ ëª¨ë“  DAOì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•˜ì.

```java
public class jdbcContext{
	private DataSource dataSource;
	public void setDataSource(DataSource dataSource){...}
	public void workWithStatementStrategy(StatementStrategy stmt) throws SQLExcetion{
		Connection c =null;
		PreparedStatement ps = null;
		try{
			c = this.dataSource.getConnection();
			ps = stmt.makePreparedStatement(c);
			ps.executeUpdate();
		}catch(SQLExcpetion e){ throw e;}
		finally{...}
	}
}
public class UserDao{
	private JdbcContext jdbcContext;
	public void setJdbcContext(...){...}
	public void add(final User user){
		this.jdbcContext.workWithStatementStrategy(
			new StatementStrategy(){...}
		)
	}
}
```

- ë¹ˆ ì˜ì¡´ê´€ê³„ ë³€ê²½